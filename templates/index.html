<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech To Tet</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.js"></script>
    <script>
        // Initialize socket connection
        const socket = io('http://localhost:5000', {
            transports: ['websocket']  
        });

        let accumulatedText = "";
        let mediaRecorder;
        let audioChunks = [];
        let silenceTimeout;

        // Handle successful connection
        socket.on('connect', () => {
            console.log('Connected to Socket.IO server');
        });

        // Handle successful connection
        socket.on('connect', () => {
            console.log('Connected to Socket.IO server');
        });

        //start recording
        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = handleDataAvailable;

            mediaRecorder.start();
            console.log("Recording started!");
            detectSilence();
        }

        //stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state != "inactive") {
                mediaRecorder.stop();
            } else {
                console.log("No active recording!");
            }
        }

        function handleDataAvailable(event) {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
                detectSilence();
            }
        }

        async function sendAudioSegment() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const arrayBuffer = await audioBlob.arrayBuffer();
            socket.emit('audio_data', new Uint8Array(arrayBuffer));
            console.log("Audio segment sent!");

            audioChunks = [];  // Reset audio chunks after sending
        }

        // Function to detect silence
        function detectSilence() {
            clearTimeout(silenceTimeout);

            silenceTimeout = setTimeout(() => {
                if (audioChunks.length > 0) {
                    sendAudioSegment();  // Send audio segment when silence is detected
                }
            }, 1000);  // Silence timeout
        }

        // Handle test message
        socket.on('test_message', (data) => {
            console.log('Test message received:', data.text);
            const messages = document.getElementById('messages');
            messages.innerHTML += `<p>${data.text}</p>`;
        });

        // Handle speech result
        socket.on('speech_result', (data) => {
            if (data) {
                console.log(`Data received - Speaker: ${data.speaker}, Text: ${data.text}, Language: ${data.language}`);
                    
                // Append the new text to accumulatedText
                accumulatedText += `${data.text}`;
                    
                // Update the div with the accumulated text
                const messages2 = document.getElementById('messages2');
                messages2.innerHTML = `<p>${accumulatedText}</p>`;
            } else {
                console.log('No data received');
            }
        });

        // Handle disconnection
        socket.on('disconnect', () => {
            console.log('Disconnected from Socket.IO server');
        });

        // Handle connection errors
        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
        });

        // Handle reconnect attempts
        socket.on('reconnect_attempt', (attempt) => {
            console.log('Reconnect attempt:', attempt);
        });

        // Handle reconnection errors
        socket.on('reconnect_error', (error) => {
            console.error('Reconnection error:', error);
        });

        // Handle reconnection success
        socket.on('reconnect', (attempt) => {
            console.log('Reconnected:', attempt);
        });

        window.onload=function(){
            document.getElementById('startButton').addEventListener('click', startRecording);
            document.getElementById('stopButton').addEventListener('click', stopRecording);
        }
        
    </script>
</head>
<body>
    <h1>Speech To Text</h1>
    <button id="startButton">Start</button>
    <button id="stopButton">Stop</button>
    <div id="messages"></div>
    <div id="messages2"></div>
    <div id="downloadSection"></div> 
</body>
</html>
